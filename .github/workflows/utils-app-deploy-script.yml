name: App Deploy - CD

on:
  workflow_call:

jobs:
  app-deploy:
    runs-on: ubuntu-latest
    name: App Deploy
    outputs:
      tag-version: ${{ steps.current-tag.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
            token: ${{ secrets.PAT }}

      - name: Get Current Tag
        id: current-tag
        uses: WyriHaximus/github-action-get-previous-tag@v1
        with:
          fallback: 1.0.0 # Optional fallback tag to use when no tag can be found

      - name: Print received tag from action
        run: echo ${{ steps.current-tag.outputs.tag }}

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_STAGE_HOST }}       
          username: ${{ secrets.AWS_STAGE_USER }}     
          key: ${{ secrets.AWS_STAGE_SSH_KEY }}
          port: 22
          script: |
            sudo -u ec2-user curl -o- https://raw.githubusercontent.com/wrappid/workflows/main/deploy-scripts/app-deploy.sh | bash -s ${{ github.repository_owner }} ${{ github.event.repository.name }}

  call-send-email-deployed:
      needs: app-deploy
      permissions: write-all
      uses: wrappid/workflows/.github/workflows/send-email-deploy.yml@main
      secrets: inherit
      with:
        tag-version: ${{ needs.app-deploy.outputs.tag-version }}