name: Create Tag - CI

on:
  workflow_call:

jobs:        
    create-tag:
      name: Create Tag
      runs-on: ubuntu-latest
      permissions: write-all
      outputs:
        tag-version:  ${{ steps.extract_version.outputs.version }}
      steps:
  
        - name: üõ† Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version: 16
  
        - name: üõí Checkout repository
          uses: actions/checkout@v4
          with:
            token: ${{ secrets.PAT }}
  
        - name: üõ† Setup gh and git
          run: |
            echo ${{secrets.PAT}} | gh auth login --with-token
            git config user.name "${{ secrets.GHUSER_NAME }}"
            git config user.email "${{ secrets.GHUSER_EMAIL }}"
  
        - name: üëÄ Process Inputs
          id: release-type-input
          run: |
            if [ -z "${{ github.event.inputs.version_type }}" ]; then
              echo "Setting default version type"
              export VERSION_TYPE_DEFAULT=" -r patch"
            else
              export VERSION_TYPE_DEFAULT="${{ github.event.inputs.version_type }}"
            fi
            echo "Version type: $VERSION_TYPE_DEFAULT"
            echo "::set-output name=version_type::$VERSION_TYPE_DEFAULT"
  
  
        - name: ‚¨áÔ∏è Setup Project
          run: | 
           echo Installing Node Modules
           npm ci
  
## TODO: 
##       ADD ATTRIBUTION TRIGGER
##       CHECK IF ANY CHANGES IN ATTRIBUTION
##       IF CHANGES FOUND, COMMIT

# - name: üîÑ Update Attribution
        #   run: |
        #    npm run attributions:gen
        #    chmod +x ./.github/scripts/attribution_header_adder.sh
        #    bash ./.github/scripts/attribution_header_adder.sh ${{ github.event.repository.name }}
        #    git pull
        #    git add ATTRIBUTIONS.md
        #    git commit -m "docs(global): :memo: update attribution
  
        #    update attributions content
  
        #    by Publish CI"
        #   env:
        #     GITHUB_TOKEN: ${{ secrets.PAT }}
  
        - name: ‚¨ÜÔ∏è Update version
          run:  npm run release -- ${{ steps.release-type-input.outputs.version_type}}
  
  
        - name: üöÄ Update remote repository
          run: git push --follow-tags origin development

          
        - name: Extract version
          id: extract_version
          uses: Saionaro/extract-package-version@v1.0.6
    
        - name: Print version
          run: echo ${{ steps.extract_version.outputs.version }}


    call-send-email-tag-created:
          needs: create-tag
          permissions: write-all
          uses: wrappid/workflows/.github/workflows/send-email-tag-created.yml@main
          secrets: inherit
          with:
            # email-to: "${{ secrets.IDS }}"
            # email-cc: "${{ secrets.MAINTAINER_ID }}"
            tag-version: ${{ needs.create-tag.outputs.tag-version }}
            
  
      
  
